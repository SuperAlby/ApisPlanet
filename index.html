<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accesso – ApisPlanet</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937;--card:#0b1220;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100svh;display:grid;place-items:center;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.15), transparent 50%),
                  radial-gradient(900px 600px at -10% 20%, rgba(34,197,94,.12), transparent 40%), var(--bg);
      color:var(--text)}
    .card{width:min(520px,92vw);padding:28px;border:1px solid var(--border);border-radius:var(--radius);
      background:linear-gradient(180deg,rgba(255,255,255,.03),transparent),var(--card);box-shadow:var(--shadow)}
    .logo{width:82px;height:82px;margin:0 auto 12px auto;display:block}
    h1{margin:4px 0 18px 0;font-size:22px;text-align:center}
    label{display:block;margin:10px 0 6px 0;color:var(--muted);font-size:14px}
    input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#0a1220;color:var(--text);outline:none;font-size:16px}
    .btn{width:100%;margin-top:16px;appearance:none;border:1px solid #14532d;border-radius:14px;padding:12px 16px;
      background:linear-gradient(180deg,#1f883d,#166534);color:white;cursor:pointer}
    .hint{margin-top:10px;color:var(--muted);text-align:center;font-size:13px}
    .meta{margin-top:16px;display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <!-- Logo ape stilizzato -->
    <svg class="logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="32" cy="32" r="30" fill="#0b1220" stroke="#1f2937"/>
      <ellipse cx="32" cy="34" rx="16" ry="12" fill="#f59e0b" stroke="#1f2937"/>
      <path d="M16 34h32M16 30h32M16 38h32" stroke="#1f2937" stroke-width="3"/>
      <circle cx="23" cy="26" r="4" fill="#22c55e" stroke="#1f2937"/>
      <circle cx="41" cy="26" r="4" fill="#22c55e" stroke="#1f2937"/>
      <path d="M28 44c2 2 6 2 8 0" stroke="#94a3b8" stroke-width="3" stroke-linecap="round"/>
    </svg>
    <h1>ApisPlanet</h1>
    <form id="loginForm">
      <label>Nome utente</label>
      <input id="user" autocomplete="username" placeholder="api" />
      <label>Password</label>
      <input id="pass" type="password" autocomplete="current-password" placeholder="api" />
      <button class="btn" type="submit">Accedi</button>
    </form>
    <div class="hint">Demo: utente <b>api</b> · password <b>api</b></div>
    <div class="meta">
      <span id="cfgInfo"></span>
      <a href="#" id="toSettings" style="color:#93c5fd">Impostazioni Cloud</a>
    </div>
  </div>

  <dialog id="cloudSettings" style="border:1px solid var(--border);border-radius:16px;background:#0b1220;color:var(--text);padding:16px;max-width:520px">
    <h3>Impostazioni Cloud (Gist GitHub)</h3>
    <label>ID Gist</label><input id="cfgGist"/>
    <label>Token GitHub (gist)</label><input id="cfgToken"/>
    <label>Nome file dati</label><input id="cfgFile" value="apiari.json"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button onclick="clearSettings()">Pulisci</button>
      <button onclick="this.closest('dialog').close()">Annulla</button>
      <button onclick="saveSettings()">Salva impostazioni</button>
    </div>
  </dialog>

  <script>
    const AUTH_KEY = 'auth.user';
    const CLOUD_KEYS = { gistId: 'cloud.gistId', token: 'cloud.token', filename: 'cloud.filename' };

    function getCloudConfig(){
      return {
        gistId: localStorage.getItem(CLOUD_KEYS.gistId) || '',
        token:  localStorage.getItem(CLOUD_KEYS.token)  || '',
        filename: localStorage.getItem(CLOUD_KEYS.filename) || 'apiari.json'
      };
    }
    function setCloudConfig({gistId, token, filename}){
      if (gistId != null)  localStorage.setItem(CLOUD_KEYS.gistId, gistId.trim());
      if (token != null)   localStorage.setItem(CLOUD_KEYS.token, token.trim());
      if (filename != null)localStorage.setItem(CLOUD_KEYS.filename, filename.trim());
      try { saveConfigFile().catch(()=>{}); } catch(e){}
    }
    function clearSettings(){
      localStorage.removeItem(CLOUD_KEYS.gistId);
      localStorage.removeItem(CLOUD_KEYS.token);
      localStorage.removeItem(CLOUD_KEYS.filename);
      try { document.getElementById('cloudSettings').close(); } catch(e){}
      refreshCfgInfo();
    }
    async function saveConfigFile(){
      const { gistId, token, filename } = getCloudConfig();
      if (!gistId || !token) return;
      const cfg = { appName: 'ApisPlanet', filename };
      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        method:'PATCH',
        headers:{
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ files: { 'config.json': { content: JSON.stringify(cfg, null, 2) } } })
      });
      return res.ok;
    }
    async function tryLoadConfigFile(){
      const { gistId, token } = getCloudConfig();
      if (!gistId || !token) return;
      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers:{
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      if (!res.ok) return;
      const gist = await res.json();
      const file = gist.files?.['config.json'];
      if (file?.content) {
        try{
          const cfg = JSON.parse(file.content);
          if (cfg?.filename) localStorage.setItem(CLOUD_KEYS.filename, cfg.filename);
        }catch(e){}
      }
      refreshCfgInfo();
    }
    function refreshCfgInfo(){
      const el = document.getElementById('cfgInfo');
      const { gistId, filename } = getCloudConfig();
      el.textContent = gistId ? `Gist: ${gistId.slice(0,6)}… · file: ${filename}` : 'Cloud non configurato';
    }

    document.getElementById('toSettings').addEventListener('click', (e)=>{
      e.preventDefault();
      const dlg = document.getElementById('cloudSettings');
      const { gistId, token, filename } = getCloudConfig();
      dlg.querySelector('#cfgGist').value = gistId;
      dlg.querySelector('#cfgToken').value = token;
      dlg.querySelector('#cfgFile').value  = filename;
      if (typeof dlg.showModal === 'function') dlg.showModal(); else {
        const g = prompt('ID Gist:', gistId||''); if (g===null) return;
        const t = prompt('Token (scope: gist):', token||''); if (t===null) return;
        const f = prompt('Nome file dati:', filename||'apiari.json') || 'apiari.json';
        setCloudConfig({ gistId:g, token:t, filename:f });
      }
    });
    function saveSettings(){
      const dlg = document.getElementById('cloudSettings');
      const gistId = dlg.querySelector('#cfgGist').value.trim();
      const token  = dlg.querySelector('#cfgToken').value.trim();
      const file   = (dlg.querySelector('#cfgFile').value.trim() || 'apiari.json');
      setCloudConfig({ gistId, token, filename:file });
      try { dlg.close(); } catch(e){}
      refreshCfgInfo();
    }

    (function(){
      refreshCfgInfo();
      const existing = localStorage.getItem(AUTH_KEY);
      if (existing === 'api') {
        tryLoadConfigFile().finally(()=>{
          const base = (new URL('.', location.href)).href;
          location.href = base + 'GestioneApiario.html';
        });
        return;
      }
      document.getElementById('loginForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value;
         if (u === 'api' && p === 'api') {
          localStorage.setItem(AUTH_KEY, 'api');
          tryLoadConfigFile().finally(()=>{
            const base = (new URL('.', location.href)).href;
            // CAMBIARE QUI: Reindirizza alla pagina di riepilogo
            location.href = base + 'GestioneApiario.html'; 
          });
        } else {
          alert('Credenziali non valide. Usa utente "api" e password "api".');
        }
      });
    })();
  </script>
</body>
</html>
