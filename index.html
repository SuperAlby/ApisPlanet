<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Apiari ‚Äì Elenco</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#3b82f6;--danger:#ef4444;--warn:#f59e0b;--card:#0b1220;--border:#1f2937;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.15), transparent 50%),
                  radial-gradient(900px 600px at -10% 20%, rgba(34,197,94,.12), transparent 40%), var(--bg);
      color:var(--text);}
    header{position:sticky;top:0;z-index:9;background:rgba(11,18,32,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0;display:flex;align-items:center;gap:12px}
    .badge{font-size:12px;color:var(--bg);background:var(--accent);padding:2px 8px;border-radius:999px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#0f1a2f,#0c1426);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(180deg,#1f883d,#166534);border-color:#14532d}
    .btn.warn{background:linear-gradient(180deg,#a16207,#92400e);border-color:#78350f}
    .btn.ghost{background:transparent}
    .btn.blue{background:linear-gradient(180deg,#1e3a8a,#1e40af);border-color:#1e3a8a}
    #cloudStatus{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:12px}
    .muted{color:var(--muted)}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .flex{display:flex;gap:8px;align-items:center}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){ .row{grid-template-columns:1fr} }
    .search{display:flex;gap:8px}
    input,textarea,select{width:100%;background:#0a1220;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .frames-mini{display:grid;grid-template-columns:repeat(10,1fr);gap:2px;margin-top:6px}
    .frame-mini{height:32px;border-radius:4px;border:1px solid var(--border)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    dialog{border:1px solid var(--border);border-radius:16px;background:var(--card);color:var(--text);padding:16px;max-width:520px}
    .dlg-row{display:grid;grid-template-columns:1fr;gap:8px;margin:8px 0}
    .dlg-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;gap:12px;">
      <h1>üêù Gestione Apiari <span class="badge">Elenco</span></h1>
      <div style="flex:1"></div>
      <span id="cloudStatus">Cloud: non configurato</span>
      <div class="toolbar">
        <button class="btn" id="btnSettings">Impostazioni Cloud</button>
        <button class="btn blue" id="btnCloudLoad">Scarica</button>
        <button class="btn primary" id="btnCloudSave">Salva</button>
        <button class="btn" id="btnExport">Esporta</button>
        <label class="btn ghost">Importa <input id="fileImport" type="file" accept="application/json" hidden></label>
        <button class="btn warn" id="btnReset">Azzera</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:20px;">
    <div class="grid">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <h3>Apiari</h3>
          <div class="search">
            <input id="searchApiary" placeholder="Cerca per nome o luogo‚Ä¶" />
            <button class="btn" id="btnNewApiary">+ Nuovo</button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="apiaryList" class="list"></div>
      </section>

      <section class="card">
        <div id="emptyState">
          <h3>Benvenuto üëã</h3>
          <p class="muted">Crea un apiario con ‚Äú+ Nuovo‚Äù oppure selezionane uno. I dati sono salvati nel tuo browser o (se configurato) sincronizzati su Gist.</p>
        </div>

        <div id="apiaryEditor" style="display:none;">
          <h3 id="apiaryTitle">Dettagli apiario</h3>
          <div class="row">
            <div><label>Nome</label><input id="apiaryName" /></div>
            <div><label>Luogo</label><input id="apiaryLocation" /></div>
          </div>
          <div style="margin-top:12px;"><label>Note</label><textarea id="apiaryNotes"></textarea></div>
          <div class="flex" style="margin-top:12px;">
            <button class="btn primary" id="btnSaveApiary">Salva</button>
            <button class="btn" id="btnAddHive">+ Aggiungi arnia</button>
            <button class="btn warn" id="btnDeleteApiary">Elimina apiario</button>
          </div>
          <div class="divider"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <h3>Arnie</h3>
            <div class="search"><input id="searchHive" placeholder="Cerca arnia‚Ä¶"/></div>
          </div>
          <div id="hivesList" class="list" style="margin-top:8px;"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Dialog impostazioni cloud -->
  <dialog id="cloudSettings">
    <h3>Impostazioni Cloud (Gist GitHub)</h3>
    <div class="dlg-row">
      <label>ID Gist (privato)</label>
      <input id="cfgGist" placeholder="es. a1b2c3d4..." />
    </div>
    <div class="dlg-row">
      <label>Token GitHub (scope: gist)</label>
      <input id="cfgToken" placeholder="token..." />
    </div>
    <div class="dlg-row">
      <label>Nome file nel Gist</label>
      <input id="cfgFile" placeholder="apiari.json" />
    </div>
    <div class="dlg-actions">
      <button class="btn ghost" onclick="clearSettings()">Pulisci</button>
      <button class="btn" onclick="document.getElementById('cloudSettings').close()">Annulla</button>
      <button class="btn primary" onclick="saveSettings()">Salva impostazioni</button>
    </div>
  </dialog>

  <template id="tplApiaryItem">
    <div class="item">
      <div>
        <div class="flex" style="gap:6px;">
          <strong class="name"></strong>
          <span class="pill"><span class="hivesCount">0</span> arnie</span>
        </div>
        <small class="muted location"></small>
      </div>
      <div class="flex">
        <button class="btn" data-action="open">Apri</button>
        <button class="btn warn" data-action="del">Elimina</button>
      </div>
    </div>
  </template>

  <template id="tplHiveItem">
    <div class="item">
      <div>
        <div class="flex" style="gap:6px;">
          <strong class="name"></strong>
          <span class="pill status"></span>
          <span class="pill">F:<span class="strength"></span></span>
          <span class="pill">M:<span class="supers"></span></span>
        </div>
        <small class="muted updated"></small>
        <div class="frames-mini" title="Schema favi"></div>
      </div>
      <div class="flex">
        <button class="btn" data-action="open">Apri</button>
        <button class="btn warn" data-action="del">Elimina</button>
      </div>
    </div>
  </template>

  <script>
    // 1) FIRST: define cloud (also defines storeKey)
    
// ====== CLOUD SYNC (Settings panel + status) ======
const CLOUD_KEYS = { gistId: 'cloud.gistId', token: 'cloud.token', filename: 'cloud.filename' };
const storeKey = 'apiariesData.v0';

function getCloudConfig(){
  return {
    gistId: localStorage.getItem(CLOUD_KEYS.gistId) || '',
    token:  localStorage.getItem(CLOUD_KEYS.token)  || '',
    filename: localStorage.getItem(CLOUD_KEYS.filename) || 'apiari.json'
  };
}
function setCloudConfig({gistId, token, filename}){
  if (gistId != null)  localStorage.setItem(CLOUD_KEYS.gistId, gistId.trim());
  if (token != null)   localStorage.setItem(CLOUD_KEYS.token, token.trim());
  if (filename != null)localStorage.setItem(CLOUD_KEYS.filename, filename.trim());
}

function ghHeaders(){
  const { token } = getCloudConfig();
  return { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' };
}

const cloudStatusEl = () => document.getElementById('cloudStatus');

function setStatus(text, ok=null){
  const el = cloudStatusEl(); if (!el) return;
  el.textContent = text;
  el.style.borderColor = ok === true ? '#14532d' : ok === false ? '#7f1d1d' : 'var(--border)';
  el.style.background = ok === true ? 'linear-gradient(180deg,#1f883d,#166534)' :
                       ok === false ? 'linear-gradient(180deg,#7f1d1d,#450a0a)' :
                                      'linear-gradient(180deg,#0f1a2f,#0c1426)';
}

async function cloudLoad(){
  const { gistId, filename } = getCloudConfig();
  if (!gistId) { setStatus('Cloud: non configurato', null); throw new Error('Cloud non configurato'); }
  const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers: ghHeaders() });
  if (!res.ok) { setStatus('Cloud: errore lettura', false); throw new Error('Errore lettura Gist: ' + res.status); }
  const gist = await res.json();
  const file = gist.files?.[filename];
  if (!file || !file.content) { setStatus('Cloud: file assente', false); throw new Error('File non trovato nel Gist'); }
  const data = JSON.parse(file.content);
  if (!Array.isArray(data)) { setStatus('Cloud: JSON non valido', false); throw new Error('Formato JSON non valido'); }
  state.data = data;
  localStorage.setItem(storeKey, JSON.stringify(state.data));
  setStatus('Cloud: dati caricati', true);
}

async function cloudSave({keepalive=false}={}){
  const { gistId, filename } = getCloudConfig();
  if (!gistId) { setStatus('Cloud: non configurato', null); return; } // silenzioso se non configurato
  const body = { files: { [filename]: { content: JSON.stringify(state.data, null, 2) } } };
  const res = await fetch(`https://api.github.com/gists/${gistId}`, {
    method:'PATCH', headers: ghHeaders(), body: JSON.stringify(body), keepalive
  });
  if (!res.ok) { setStatus('Cloud: errore salvataggio', false); throw new Error('Errore salvataggio Gist: ' + res.status); }
  setStatus('Cloud: sincronizzato', true);
}

// debounce helper
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
const scheduleCloudSave = debounce(() => cloudSave().catch(()=>{}), 800);

// Settings Panel handlers (with fallback to prompts)
function openSettings(){
  const dlg = document.getElementById('cloudSettings');
  if (!dlg || typeof dlg.showModal !== 'function') {
    try {
      const cfg = getCloudConfig();
      const gistId = prompt('ID Gist (privato):', cfg.gistId || '');
      if (gistId === null) return;
      const token  = prompt('Token GitHub (permesso: gist):', cfg.token || '');
      if (token === null) return;
      const filename = prompt('Nome file nel Gist:', cfg.filename || 'apiari.json') || 'apiari.json';
      setCloudConfig({ gistId, token, filename });
      setStatus('Cloud: impostazioni salvate', null);
      return;
    } catch (e) {
      alert('Impossibile aprire impostazioni: ' + (e.message||e));
      return;
    }
  }
  const { gistId, token, filename } = getCloudConfig();
  try { dlg.querySelector('#cfgGist').value = gistId; } catch(e){}
  try { dlg.querySelector('#cfgToken').value = token; } catch(e){}
  try { dlg.querySelector('#cfgFile').value = filename; } catch(e){}
  try { dlg.showModal(); } catch(e) { openSettings(); return; }
}
function saveSettings(){
  const dlg = document.getElementById('cloudSettings');
  let gistId='', token='', filename='apiari.json';
  try {
    gistId = dlg.querySelector('#cfgGist').value.trim();
    token  = dlg.querySelector('#cfgToken').value.trim();
    filename = (dlg.querySelector('#cfgFile').value.trim() || 'apiari.json');
  } catch(e){}
  setCloudConfig({ gistId, token, filename });
  try { dlg.close(); } catch(e){}
  setStatus('Cloud: impostazioni salvate', null);
}
function clearSettings(){
  localStorage.removeItem(CLOUD_KEYS.gistId);
  localStorage.removeItem(CLOUD_KEYS.token);
  localStorage.removeItem(CLOUD_KEYS.filename);
  try { document.getElementById('cloudSettings').close(); } catch(e){}
  setStatus('Cloud: non configurato', null);
}

// Auto save when page is hidden/closed
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    try { cloudSave({keepalive:true}); } catch(e){}
  }
});


    // 2) THEN: helpers that use storeKey
    const byId = id => document.getElementById(id);
    const uid = () => Math.random().toString(36).slice(2,9);
    const loadData = () => JSON.parse(localStorage.getItem(storeKey) || '[]');
    const saveData = (d) => { localStorage.setItem(storeKey, JSON.stringify(d)); scheduleCloudSave(); };
    const state = { data: loadData(), selectedApiaryId: null };

    function notify(msg){ try{ console.log(msg); }catch(_){} }
    function getApiary(){ return state.data.find(a => a.id === state.selectedApiaryId); }
    function ensureFrames(h){ if(!h.frames || h.frames.length!==10){ h.frames = Array.from({length:10}, ()=> 'vuoto'); } }
    const FRAME_COLORS = { vuoto:'#111827', foglio:'#2563eb', costruito:'#10b981', covata_aperta:'#f59e0b', covata_operculata:'#d97706', miele:'#eab308', polline:'#a855f7', diaframma:'#64748b' };
    function frameColor(t){ return FRAME_COLORS[t] || '#334155'; }

    function renderApiaries(){
      const list = byId('apiaryList'); list.innerHTML='';
      const q = (byId('searchApiary').value||'').toLowerCase();
      state.data.filter(a => !q || (a.name||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q)).forEach(a => {
        const tpl = byId('tplApiaryItem').content.cloneNode(true);
        tpl.querySelector('.name').textContent = a.name || 'Senza nome';
        tpl.querySelector('.location').textContent = a.location || '';
        tpl.querySelector('.hivesCount').textContent = (a.hives||[]).length;
        const item = tpl.querySelector('.item');
        item.querySelector('[data-action="open"]').onclick = () => openApiary(a.id);
        item.querySelector('[data-action="del"]').onclick = () => { if(!confirm('Eliminare questo apiario?')) return;
          state.data = state.data.filter(x=>x.id!==a.id); saveData(state.data); renderApiaries(); renderDetail(); notify('Apiario eliminato'); };
        list.appendChild(item);
      });
    }
    function openApiary(id){ state.selectedApiaryId = id; renderDetail(); }
    function renderHives(){
      const a=getApiary(); const list=byId('hivesList'); list.innerHTML='';
      const q = (byId('searchHive').value||'').toLowerCase();
      (a.hives||[]).filter(h=> !q || (h.name||'').toLowerCase().includes(q)).forEach(h=>{
        const tpl = byId('tplHiveItem').content.cloneNode(true);
        tpl.querySelector('.name').textContent = h.name || 'Arnia';
        tpl.querySelector('.strength').textContent = h.strength ?? '-';
        tpl.querySelector('.supers').textContent = h.supers ?? 0;
        tpl.querySelector('.status').textContent = `Regina: ${h.queenStatus||'?'}`;
        const lastUpd = new Date(Math.max(...(h.inspections||[]).map(i=>+new Date(i.date)), ...(h.harvests||[]).map(r=>+new Date(r.date)), 0));
        tpl.querySelector('.updated').textContent = lastUpd.getTime()? `Ultimo aggiornamento: ${lastUpd.toLocaleDateString()}` : 'Nessun aggiornamento';
        ensureFrames(h);
        const mini = tpl.querySelector('.frames-mini'); mini.innerHTML='';
        (h.frames||[]).forEach((ft,idx)=>{ const span=document.createElement('div'); span.className='frame-mini'; span.title=`Favo ${idx+1}: ${ft}`; span.style.background=frameColor(ft); mini.appendChild(span); });
        const item = tpl.querySelector('.item');
        item.querySelector('[data-action="open"]').onclick = () => { const base=(new URL('.', location.href)).href; location.href = `${base}hive.html?apiary=${a.id}&hive=${h.id}`; };
        item.querySelector('[data-action="del"]').onclick = () => { if(!confirm('Eliminare questa arnia?')) return;
          a.hives = a.hives.filter(x=>x.id!==h.id); saveData(state.data); renderHives(); notify('Arnia eliminata'); };
        list.appendChild(item);
      });
    }
    function renderDetail(){
      const a=getApiary();
      byId('emptyState').style.display = a? 'none':'block';
      byId('apiaryEditor').style.display = a? 'block':'none';
      if(!a) return;
      byId('apiaryTitle').textContent = `Apiario: ${a.name||'Senza nome'}`;
      byId('apiaryName').value = a.name || '';
      byId('apiaryLocation').value = a.location || '';
      byId('apiaryNotes').value = a.notes || '';
      renderHives();
    }

    // Actions
    byId('btnNewApiary').onclick = async () => { const name = prompt('Nome del nuovo apiario'); if(!name) return;
      const a = { id: uid(), name, location:'', notes:'', hives:[] };
      state.data.push(a); saveData(state.data); renderApiaries(); openApiary(a.id); notify('Apiario creato'); };
    byId('btnSaveApiary').onclick = () => { const a=getApiary(); if(!a) return;
      a.name = byId('apiaryName').value.trim(); a.location = byId('apiaryLocation').value.trim(); a.notes = byId('apiaryNotes').value.trim();
      saveData(state.data); renderApiaries(); notify('Apiario salvato'); };
    byId('btnDeleteApiary').onclick = () => { const a=getApiary(); if(!a) return; if(!confirm('Eliminare questo apiario e tutte le arnie?')) return;
      state.data = state.data.filter(x=>x.id!==a.id); saveData(state.data); renderApiaries(); renderDetail(); notify('Apiario eliminato'); };
    byId('btnAddHive').onclick = async () => { const a=getApiary(); if(!a) return; const name = prompt('Nome / codice arnia'); if(!name) return;
      const h = { id: uid(), name, queenStatus:'sconosciuto', strength:3, supers:0, notes:'', inspections:[], harvests:[], frames: Array.from({length:10},()=> 'vuoto') };
      a.hives.push(h); saveData(state.data); renderHives(); notify('Arnia aggiunta'); };

    byId('searchApiary').oninput = renderApiaries;
    byId('searchHive').oninput = renderHives;

    // Cloud buttons & settings
    document.getElementById('btnSettings').onclick = openSettings;
    document.getElementById('btnCloudLoad').onclick = async () => { try{ await cloudLoad(); renderApiaries(); renderDetail(); notify('Scaricato dal cloud'); }catch(e){ alert(e.message); } };
    document.getElementById('btnCloudSave').onclick = async () => { try{ await cloudSave(); notify('Salvato sul cloud'); }catch(e){ alert(e.message); } };

    // Init: load from cloud (if set) then render
    (async function init(){
      const { gistId } = getCloudConfig();
      if (gistId) { try{ await cloudLoad(); }catch(e){ console.error(e); } }
      else { setStatus('Cloud: non configurato', null); }
      renderApiaries(); renderDetail();
    })();

    // --- Refresh UI quando torni alla pagina (Back/Forward cache, focus, storage) ---
    function rehydrateFromStorage(){
      try {
        const prev = state.selectedApiaryId;
        state.data = loadData();
        renderApiaries();
        if (prev && state.data.some(a => a.id === prev)) {
          state.selectedApiaryId = prev;
        }
        renderDetail();
      } catch(e){ console.error('rehydrate error', e); }
    }
    window.addEventListener('pageshow', (e) => { rehydrateFromStorage(); });
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') rehydrateFromStorage(); });
    window.addEventListener('focus', rehydrateFromStorage);
    window.addEventListener('storage', (e) => { if (e.key === storeKey) rehydrateFromStorage(); });
  </script>
</body>
</html>
