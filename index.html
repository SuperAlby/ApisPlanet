<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gestione Apiari â€“ Elenco</title>
<style>
  :root{--border:#1f2937;--card:#0b1220;--bg:#0f172a;--text:#e5e7eb;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--border)}
  .btn{padding:8px 12px;border:1px solid var(--border);background:#0f1a2f;color:var(--text);border-radius:8px}
  #cloudStatus{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:8px}
</style>
</head>
<body>
<header>
  <button class="btn" id="btnSettings">Impostazioni Cloud</button>
  <button class="btn" id="btnCloudLoad">Scarica</button>
  <button class="btn" id="btnCloudSave">Salva</button>
  <span id="cloudStatus">Cloud: non configurato</span>
</header>

<dialog id="cloudSettings">
  <h3>Impostazioni Cloud (Gist GitHub)</h3>
  <label>ID Gist</label><input id="cfgGist"/><br/>
  <label>Token</label><input id="cfgToken"/><br/>
  <label>Nome file</label><input id="cfgFile" value="apiari.json"/><br/>
  <menu>
    <button onclick="clearSettings()" class="btn">Pulisci</button>
    <button onclick="this.closest('dialog').close()" class="btn">Annulla</button>
    <button onclick="saveSettings()" class="btn">Salva</button>
  </menu>
</dialog>

<script>
const state = { data: [] };

// ====== CLOUD SYNC (Settings panel + status) ======
const CLOUD_KEYS = { gistId: 'cloud.gistId', token: 'cloud.token', filename: 'cloud.filename' };
const storeKey = 'apiariesData.v0';

function getCloudConfig(){
  return {
    gistId: localStorage.getItem(CLOUD_KEYS.gistId) || '',
    token:  localStorage.getItem(CLOUD_KEYS.token)  || '',
    filename: localStorage.getItem(CLOUD_KEYS.filename) || 'apiari.json'
  };
}
function setCloudConfig({gistId, token, filename}){
  if (gistId != null)  localStorage.setItem(CLOUD_KEYS.gistId, gistId.trim());
  if (token != null)   localStorage.setItem(CLOUD_KEYS.token, token.trim());
  if (filename != null)localStorage.setItem(CLOUD_KEYS.filename, filename.trim());
}

function ghHeaders(){
  const { token } = getCloudConfig();
  return { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' };
}

const cloudStatusEl = () => document.getElementById('cloudStatus');

function setStatus(text, ok=null){
  const el = cloudStatusEl(); if (!el) return;
  el.textContent = text;
  el.style.borderColor = ok === true ? '#14532d' : ok === false ? '#7f1d1d' : 'var(--border)';
  el.style.background = ok === true ? 'linear-gradient(180deg,#1f883d,#166534)' :
                       ok === false ? 'linear-gradient(180deg,#7f1d1d,#450a0a)' :
                                      'linear-gradient(180deg,#0f1a2f,#0c1426)';
}

async function cloudLoad(){
  const { gistId, filename } = getCloudConfig();
  if (!gistId) { setStatus('Cloud: non configurato', null); throw new Error('Cloud non configurato'); }
  const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers: ghHeaders() });
  if (!res.ok) { setStatus('Cloud: errore lettura', false); throw new Error('Errore lettura Gist: ' + res.status); }
  const gist = await res.json();
  const file = gist.files?.[filename];
  if (!file || !file.content) { setStatus('Cloud: file assente', false); throw new Error('File non trovato nel Gist'); }
  const data = JSON.parse(file.content);
  if (!Array.isArray(data)) { setStatus('Cloud: JSON non valido', false); throw new Error('Formato JSON non valido'); }
  state.data = data;
  localStorage.setItem(storeKey, JSON.stringify(state.data));
  setStatus('Cloud: dati caricati', true);
}

async function cloudSave({keepalive=false}={}){
  const { gistId, filename } = getCloudConfig();
  if (!gistId) { setStatus('Cloud: non configurato', null); return; }
  const body = { files: { [filename]: { content: JSON.stringify(state.data, null, 2) } } };
  const res = await fetch(`https://api.github.com/gists/${gistId}`, {
    method:'PATCH', headers: ghHeaders(), body: JSON.stringify(body), keepalive
  });
  if (!res.ok) { setStatus('Cloud: errore salvataggio', false); throw new Error('Errore salvataggio Gist: ' + res.status); }
  setStatus('Cloud: sincronizzato', true);
}

// debounce helper
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
const scheduleCloudSave = debounce(() => cloudSave().catch(()=>{}), 800);

// Settings Panel handlers
function openSettings(){
  const dlg = document.getElementById('cloudSettings');
  if (!dlg || typeof dlg.showModal !== 'function') {
    try {
      const cfg = getCloudConfig();
      const gistId = prompt('ID Gist (privato):', cfg.gistId || '');
      if (gistId === null) return;
      const token  = prompt('Token GitHub (permesso: gist):', cfg.token || '');
      if (token === null) return;
      const filename = prompt('Nome file nel Gist:', cfg.filename || 'apiari.json') || 'apiari.json';
      setCloudConfig({ gistId, token, filename });
      setStatus('Cloud: impostazioni salvate', null);
      return;
    } catch (e) {
      alert('Impossibile aprire impostazioni: ' + (e.message||e));
      return;
    }
  }
  const dlg = document.getElementById('cloudSettings');
  // Original simple version; we'll patch this function below in the fallback build.
  const { gistId, token, filename } = getCloudConfig();
  try { dlg.querySelector('#cfgGist').value = gistId; } catch(e){}
  try { dlg.querySelector('#cfgToken').value = token; } catch(e){}
  try { dlg.querySelector('#cfgFile').value = filename; } catch(e){}
  try { dlg.showModal(); } catch(e) { /* fallback */ openSettings(); return; }
}
function saveSettings(){
  const dlg = document.getElementById('cloudSettings');
  let gistId='', token='', filename='apiari.json';
  try {
    gistId = dlg.querySelector('#cfgGist').value.trim();
    token  = dlg.querySelector('#cfgToken').value.trim();
    filename = (dlg.querySelector('#cfgFile').value.trim() || 'apiari.json');
  } catch(e){
    // ignore
  }
  setCloudConfig({ gistId, token, filename });
  try { dlg.close(); } catch(e){}
  setStatus('Cloud: impostazioni salvate', null);
}
function clearSettings(){
  localStorage.removeItem(CLOUD_KEYS.gistId);
  localStorage.removeItem(CLOUD_KEYS.token);
  localStorage.removeItem(CLOUD_KEYS.filename);
  try { document.getElementById('cloudSettings').close(); } catch(e){}
  setStatus('Cloud: non configurato', null);
}

// Auto save when page is hidden/closed
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    try { cloudSave({keepalive:true}); } catch(e){}
  }
});

document.getElementById('btnSettings').onclick = openSettings;
document.getElementById('btnCloudLoad').onclick = async () => { try{ await cloudLoad(); }catch(e){ alert(e.message); } };
document.getElementById('btnCloudSave').onclick = async () => { try{ await cloudSave(); }catch(e){ alert(e.message); } };
</script>
</body></html>