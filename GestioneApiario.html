<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riepilogo Apiari ‚Äì ApisPlanet</title>
    <style>
        /* Stili Base */
        :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937;--card:#0b1220;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px}
        *{box-sizing:border-box}
        body{margin:0;min-height:100vh;
            font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
            background: radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.15), transparent 50%),
                        radial-gradient(900px 600px at -10% 20%, rgba(34,197,94,.12), transparent 40%), var(--bg);
            color:var(--text);
            padding: 20px;}
        .card-container{width:min(900px,96vw);margin:20px auto;
            display:flex;flex-direction:column;gap:20px;}
        .card{padding:28px;border:1px solid var(--border);border-radius:var(--radius);
            background:linear-gradient(180deg,rgba(255,255,255,.03),transparent),var(--card);box-shadow:var(--shadow)}
        h1{margin:4px 0 18px 0;font-size:32px;text-align:center;color:var(--accent)}
        h2{margin:4px 0 16px 0;font-size:20px;color:var(--accent)}
        label{display:block;margin:10px 0 6px 0;color:var(--muted);font-size:14px}
        input, select, textarea{width:100%;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#0a1220;color:var(--text);outline:none;font-size:16px;margin-bottom:12px;resize:vertical}
        .btn{margin-top:16px;appearance:none;border:1px solid #14532d;border-radius:14px;padding:12px 16px;
            background:linear-gradient(180deg,#1f883d,#166534);color:white;cursor:pointer;font-size:16px;
            display: block; width: 100%;}
        .btn:hover{filter: brightness(1.1);}
        .btn-small{width:auto;margin:0 0 10px 0;padding:8px 14px;font-size:14px}
        .form-section{margin-bottom:20px;}
        
        /* Stili Riepilogo */
        table {width: 100%;border-collapse: collapse;margin-top: 15px;}
        th, td {padding: 12px 15px;text-align: left;border-bottom: 1px solid var(--border);}
        th {background-color: var(--panel);color: var(--accent);font-weight: bold;}
        tr:hover {background-color: #1a2333;}
        .action-link {color: #93c5fd;cursor: pointer;text-decoration: none;}
        .header-controls {display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px;}
        #sync-status {font-size: 14px; text-align: center; margin-top: 10px; color: var(--muted);}
        .btn-add {background: linear-gradient(180deg, #10b981, #059669); border: 1px solid #065f46; color: white;}
    </style>
</head>
<body>

    <div id="app-container" style="display:none;">

        <h1>Riepilogo Apiari ApisPlanet üè°</h1>
        <div id="sync-status">Sincronizzazione in corso...</div>

        <div class="card-container">

            <div class="card">
                <div class="header-controls">
                    <div>
                        <label for="selettore-apiario">Seleziona Apiario</label>
                        <select id="selettore-apiario" onchange="loadArnie()">
                            </select>
                    </div>
                    <button class="btn btn-small btn-add" onclick="goToArnia()">+ Aggiungi Nuova Arnia</button>
                </div>
            </div>

            <div class="card">
                <h2>Arnie nell'Apiario Selezionato (<span id="apiario-corrente"></span>)</h2>
                <table id="arnie-table">
                    <thead>
                        <tr>
                            <th>ID Arnia</th>
                            <th>Ultima Ispezione</th>
                            <th>Stato</th>
                            <th>Intervento</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <p id="no-arnie" style="text-align:center; color:var(--muted); margin-top: 20px; display:none;">Nessuna arnia registrata per questo apiario.</p>
            </div>
            
            <button class="btn" type="button" onclick="logout()">Logout</button>
            
        </div>
    </div>

    <script>
        const AUTH_KEY = 'auth.user'; 
        const STORAGE_KEY = 'apisplanet.arnie';
        const CURRENT_APIARY_KEY = 'apisplanet.current_apiary';
        let arnieData = {}; // GLOBAL: i dati dell'applicazione sono qui
        
        // Dati di esempio (fallback se il cloud √® vuoto)
        const defaultArnieData = {
            'Apiario_A': [
                { id: 'AR001', ultima_ispezione: '2025-09-20', stato: 'Forte üí™', intervento: 'Nutrizione', favi: 10 },
            ],
            'Apiario_B': []
        };
        
        // --- FUNZIONI DI GESTIONE CLOUD GLOBALI (Necessitano di window.getCloudConfig) ---

        async function loadDataFromCloud() {
            document.getElementById('sync-status').textContent = 'Sincronizzazione in corso...';
            // Usa window.getCloudConfig (definita in index.html) per prendere i dati hardcoded/configurati
            const config = window.getCloudConfig ? window.getCloudConfig() : {};
            
            // 1. Caricamento da Cloud
            if (config.gistId && config.token) {
                try {
                    const res = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        headers: { 'Authorization': `token ${config.token}` }
                    });
                    
                    if (!res.ok) {
                        // Se fallisce (es. 401, 404), passa al fallback locale
                        throw new Error(`Accesso Gist fallito (Status: ${res.status}).`);
                    }
                    
                    const gist = await res.json();
                    const file = gist.files?.[config.filename];
                    
                    if (file?.content) {
                        arnieData = JSON.parse(file.content);
                        document.getElementById('sync-status').textContent = 'Dati caricati dal Cloud.';
                        localStorage.setItem(STORAGE_KEY, file.content); // Cache locale
                        return;
                    }
                } catch (e) {
                    console.error("Errore Gist Cloud, fallback su locale:", e);
                    document.getElementById('sync-status').textContent = 'Errore Cloud. Dati caricati dalla cache.';
                }
            }

            // 2. Fallback su Cache Locale (localStorage)
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                arnieData = JSON.parse(storedData);
                document.getElementById('sync-status').textContent = 'Dati caricati dalla cache.';
            } else {
                // 3. Fallback su Dati di Esempio
                arnieData = defaultArnieData;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(arnieData));
                document.getElementById('sync-status').textContent = 'Dati inizializzati localmente.';
            }
        }
        
        async function saveDataToCloud(dataToSave) {
            document.getElementById('sync-status').textContent = 'Salvataggio in corso...';
            const config = window.getCloudConfig ? window.getCloudConfig() : {};

            // 1. Aggiorna la cache locale immediatamente
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));

            // 2. Salvataggio su Cloud
            if (config.gistId && config.token) {
                try {
                    const res = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ files: { [config.filename]: { content: JSON.stringify(dataToSave, null, 2) } } })
                    });
                    
                    if (!res.ok) {
                        throw new Error(`Salvataggio Gist fallito (Status: ${res.status}).`);
                    }
                    
                    document.getElementById('sync-status').textContent = 'Sincronizzato sul Cloud.';
                } catch (e) {
                    console.error("Errore salvataggio Gist:", e);
                    document.getElementById('sync-status').textContent = 'Salvataggio Cloud fallito! Dati salvati localmente.';
                }
            } else {
                document.getElementById('sync-status').textContent = 'Dati salvati solo localmente (Cloud non configurato).';
            }
        }
        
        // --- FUNZIONI DI AUTENTICAZIONE E LOGICA PAGINA ---
        
        async function checkAuthentication() {
            if (localStorage.getItem(AUTH_KEY) === 'api') {
                // 1. CARICA I DATI DAL CLOUD
                await loadDataFromCloud(); 
                
                document.getElementById('app-container').style.display = 'block';
                loadApiariesAndArnie();
            } else {
                const base = (new URL('.', location.href)).href;
                location.href = base + 'index.html'; // Reindirizza al login
            }
        }
        
        function logout() {
            localStorage.removeItem(AUTH_KEY); 
            const base = (new URL('.', location.href)).href;
            location.href = base + 'index.html';
        }
        
        function loadApiariesAndArnie() {
            
            const selector = document.getElementById('selettore-apiario');
            
            // 1. Definisci il primo Apiario disponibile come fallback
            const firstApiary = Object.keys(arnieData)[0] || 'Apiario_A';
            
            // 2. Ottieni l'apiario corrente salvato o usa il primo disponibile
            const currentApiary = localStorage.getItem(CURRENT_APIARY_KEY) || firstApiary;
            
            // 3. Assicurati che l'Apiario A esista se non ci sono dati
            if (!arnieData[firstApiary]) {
                 arnieData[firstApiary] = [];
            }
            localStorage.setItem(CURRENT_APIARY_KEY, currentApiary);
            
            selector.innerHTML = ''; // Pulisci le opzioni
            
            // Popola il selettore Apiario
            Object.keys(arnieData).forEach(apiarioId => {
                const option = document.createElement('option');
                option.value = apiarioId;
                option.textContent = apiarioId.replace('_', ' ');
                if (apiarioId === currentApiary) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            // Aggiungi opzione fittizia per gestione
            const optionManage = document.createElement('option');
            optionManage.value = 'Nuovo';
            optionManage.textContent = 'Gestisci / Aggiungi Apiario...';
            selector.appendChild(optionManage);
            
            loadArnie();
        }

        function loadArnie() {
            const selector = document.getElementById('selettore-apiario');
            let selectedApiaryId = selector.value;
            const tbody = document.querySelector('#arnie-table tbody');
            const apiarioCorrente = document.getElementById('apiario-corrente');
            const noArnie = document.getElementById('no-arnie');
            
            if (selectedApiaryId === 'Nuovo') {
                alert('Funzione per la gestione/aggiunta di nuovi apiari non implementata in questa demo.');
                const prevApiary = localStorage.getItem(CURRENT_APIARY_KEY) || Object.keys(arnieData)[0];
                selector.value = prevApiary;
                selectedApiaryId = prevApiary; 
                if (!selectedApiaryId) return; 
            }

            localStorage.setItem(CURRENT_APIARY_KEY, selectedApiaryId);
            apiarioCorrente.textContent = selectedApiaryId.replace('_', ' ');
            
            const arnie = arnieData[selectedApiaryId] || [];
            tbody.innerHTML = ''; 
            
            if (arnie.length === 0) {
                noArnie.style.display = 'block';
                return;
            } else {
                noArnie.style.display = 'none';
            }

            arnie.forEach(arnia => {
                const row = tbody.insertRow();
                row.insertCell().textContent = arnia.id;
                row.insertCell().textContent = arnia.ultima_ispezione || 'N/D';
                row.insertCell().textContent = arnia.stato || 'N/D';
                row.insertCell().textContent = arnia.intervento || 'Nessuno';
                
                const actionCell = row.insertCell();
                const link = document.createElement('a');
                link.href = '#';
                link.classList.add('action-link');
                link.textContent = 'Dettaglio/Modifica';
                link.onclick = (e) => {
                    e.preventDefault();
                    goToArnia(selectedApiaryId, arnia.id);
                };
                actionCell.appendChild(link);
            });
        }
        
        function goToArnia(apiarioId, arniaId) {
            const currentApiario = apiarioId || document.getElementById('selettore-apiario').value;

            localStorage.setItem('editApiarioId', currentApiario);
            
            if (arniaId) {
                localStorage.setItem('editArniaId', arniaId);
            } else {
                localStorage.removeItem('editArniaId');
            }
            
            const base = (new URL('.', location.href)).href;
            location.href = base + 'GestioneArnia.html';
        }

        checkAuthentication();
    </script>
</body>
</html>
